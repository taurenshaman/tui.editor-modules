"use strict";var FEF,KC;!function(e){!function(t){class a{constructor(e,t){this.appId=e,this.appSecret=t}getNoteByURL(e,t){var r=a.getUri_Api_GetNote(e);$.ajax({url:r,dataType:"json",type:"GET",contentType:"application/x-www-form-urlencoded",data:"appid="+this.appId,async:!0,processData:!1,cache:!1,crossDomain:!0,success:function(e,a,r){"function"!=typeof t||t(e)},error:function(e,t,a){var r="��Status��"+t+"��error��"+a+"��others��"+e.responseText;FEF.Tools.UIHelper.ShowError("ERROR",r)}})}getNote(e,t,r,i){var o="/api/"+a.apiVersion+"/"+e+"/"+t+"/"+r;this.getNoteByURL(o,i)}static getUri_Api_GetNote(e){var t=e;if(e.startsWith("https://localhost")&&!e.startsWith("https://localhost:44356/api")){a.apiUriPrefix="https://localhost:44356/api/"+a.apiVersion+"/";t=a.apiUriPrefix+e.substring("https://localhost:44356/".length)}else e.startsWith("https://lore.chuci.info")&&!e.startsWith("https://lore.chuci.info/api")&&(a.apiUriPrefix="https://lore.chuci.info/api/"+a.apiVersion+"/",t=a.apiUriPrefix+e.substring(a.uriPrefix.length));return t}static getUri_NoteLink(e){var t=e,r="/api/"+a.apiVersion;return e.indexOf(r)>=0&&(t=e.replace(r,"")),t}static getUri_Author_FromNoteLink(e){var t=a.uriPrefix;e.startsWith("https://localhost")&&(t="https://localhost:44356/");var r=e.substring(t.length),i=r.indexOf("/");return t+r.substring(0,i)}static getUserName_FromAuthorLink(e){var t=e.lastIndexOf("/");return e.substring(t+1)}static getClassName(t){let a="JsonDocument";switch(t){case e.Models.ModelData.Type_Document:break;case e.Models.ModelData.Type_Mind:a="MindDocument";break;case e.Models.ModelData.Type_Dialog:a="DialogDocument";break;case e.Models.ModelData.Type_Section:a="SectionDocument";break;case e.Models.ModelData.Type_List:a="ListDocument";break;case e.Models.ModelData.Type_XY:a="QuadrantAnalysisDocument";break;case e.Models.ModelData.Type_5W2H1E:a="5W2H1EDocument";break;case e.Models.ModelData.Type_LanguagePack:a="LanguagePackDocument";break;case e.Models.ModelData.Type_Topic:a="TopicDocument"}return a}static getClassUri(e){return"http://www.chuci.info/schema/lore-document#"+a.getClassName(e)}static fitDialog(e){var t=e.agents;return _.forEach(e.items,e=>{var a=e.agentId,r=_.find(t,(function(e){return e.id===a}));e.name=r.name,e.avatar="https://robohash.org/"+a+".png",e.time=new Date(e.time)}),e.items}}a.uriPrefix="https://lore.chuci.info/",a.apiVersion="v1",a.apiUriPrefix="https://lore.chuci.info/api/"+a.apiVersion+"/",t.LoreService=a}(e.Tools||(e.Tools={}))}(KC||(KC={}));class LoreCard{static inititialize(){return void 0===LoreCard.api&&LoreCard.initService("",""),LoreCard.api}static initService(e,t){return LoreCard.api=new KC.Tools.LoreService(e,t),LoreCard.api}}class LoreEditor{constructor(e){this.editor=e,this.toolbar=this.editor.getUI().getToolbar(),this.init()}addToolbarCommand_Dialog(){this.editor.eventManager.addEventType("BtnEvent_LoreCard_Dialog");const e=this;this.editor.eventManager.listen("BtnEvent_LoreCard_Dialog",(function(){if(!1===e.editor.isMarkdownMode())return;const t=["","```lorecard."+KC.Models.ModelData.Type_Dialog,"data: ","```",""].join("\n");e.editor.insertText(t)})),this.toolbar.addItem({type:"button",options:{className:"mif-chat-bubble-outline fg-orange",event:"BtnEvent_LoreCard_Dialog",tooltip:"lore:> dialog",style:"background:none;"}})}addToolbarCommand_Mind(){this.editor.eventManager.addEventType("BtnEvent_LoreCard_Mind");const e=this;this.editor.eventManager.listen("BtnEvent_LoreCard_Mind",(function(){if(!1===e.editor.isMarkdownMode())return;const t=["","```lorecard."+KC.Models.ModelData.Type_Mind,"data: ","```",""].join("\n");e.editor.insertText(t)})),this.toolbar.addItem({type:"button",options:{className:"mif-share fg-orange",event:"BtnEvent_LoreCard_Mind",tooltip:"lore:> mind",style:"background:none;"}})}addToolbarCommand_Section(){this.editor.eventManager.addEventType("BtnEvent_LoreCard_Section");const e=this;this.editor.eventManager.listen("BtnEvent_LoreCard_Section",(function(){if(!1===e.editor.isMarkdownMode())return;const t=["","```lorecard."+KC.Models.ModelData.Type_Section,"data: ","```",""].join("\n");e.editor.insertText(t)})),this.toolbar.addItem({type:"button",options:{className:"mif-book-reference fg-orange",event:"BtnEvent_LoreCard_Section",tooltip:"lore:> section",style:"background:none;"}})}addToolbarCommand_List(){this.editor.eventManager.addEventType("BtnEvent_LoreCard_List");const e=this;this.editor.eventManager.listen("BtnEvent_LoreCard_List",(function(){if(!1===e.editor.isMarkdownMode())return;const t=["","```lorecard."+KC.Models.ModelData.Type_List,"data: ","```",""].join("\n");e.editor.insertText(t)})),this.toolbar.addItem({type:"button",options:{className:"mif-list-numbered fg-orange",event:"BtnEvent_LoreCard_List",tooltip:"lore:> list",style:"background:none;"}})}init(){this.addToolbarCommand_Dialog(),this.addToolbarCommand_Mind(),this.addToolbarCommand_Section(),this.addToolbarCommand_List()}}!function(e){!function(e){e.ModuleBase=class{constructor(e){this.api=LoreCard.inititialize(),this.ModuleName=e}getDataUri(e){var t=e.match(/^.*((\r\n|\n|\r)|$)/gm),a="";return t&&t.length>0&&(t.forEach(e=>{e.startsWith("dataUri:")?a=_.replace(e,"dataUri:",""):e.startsWith("data:")?a=_.replace(e,"data:",""):e.startsWith("uri:")&&(a=_.replace(e,"uri:",""))}),a=_.trim(a)),a}createLinkButton_Note(e){const t=document.createElement("a");return t.classList.add("button","light","ml-3"),t.style.lineHeight="100%",t.style.textDecoration="none",t.innerText="Lore",t.href=e,t.target="_blank",t}createLinkButton_Author(e){const t=document.createElement("a");return t.classList.add("button","light","ml-3"),t.style.lineHeight="100%",t.style.textDecoration="none",t.innerHTML='<span class="mif-user"></span> '+KC.Tools.LoreService.getUserName_FromAuthorLink(e),t.href=e,t.target="_blank",t}createDiv_Settings(e,t){const a=document.createElement("div");return a.classList.add("mt-3","d-flex","flex-justify-center","flex-align-center"),t&&a.appendChild(t),e&&a.appendChild(e),a}}}(e.Modules||(e.Modules={}))}(FEF||(FEF={})),function(e){!function(e){class t extends e.ModuleBase{constructor(){super("lorecard.dialog")}runChatFlow(e,t){var a=$("#"+e).data("chat");a.clear();let r=0;for(var i=t.items,o=0;o<i.length;o++)!function(e){r+=1e3*i[e].delay,setTimeout((function(){var t=i[e];a.add(t)}),r)}(o)}initCard(e,t,a){var r=document.getElementById(a+"_wrapper");r.classList.add("flex-justify-center","flex-align-center");var i=document.getElementById(a);i.id=a,i.setAttribute("data-role","chat"),i.setAttribute("data-readonly","true"),i.style.maxHeight="500px";var o=KC.Tools.LoreService.getUri_NoteLink(e);const n=this.createLinkButton_Note(o);var s=KC.Tools.LoreService.getUri_Author_FromNoteLink(o);const d=this.createLinkButton_Author(s),c=this,l=document.createElement("button");l.classList.add("button","light"),l.style.lineHeight="100%",l.innerHTML='<span class="mif-refresh"></span>',l.onclick=e=>{c.runChatFlow(a,t)};const u=this.createDiv_Settings(n,d);u.appendChild(l),r.innerHTML="",r.appendChild(i),r.appendChild(u)}renderCard(e,t){let a=this;LoreCard.api.getNoteByURL(t,r=>{KC.Tools.LoreService.fitDialog(r),a.initCard(t,r,e)})}}e.DialogCard=t,e.DialogCardPlugin=function(){const{Editor:e}=toastui;var a=new t;e.codeBlockManager.setReplacer(a.ModuleName,(function(e){var t=a.getDataUri(e);if(0===t.length||t.indexOf("http")<0)return"<p class='fg-red'>Invalid format for data uri</p>";var r="divLoreSection_"+KC.Tools.CommonUtitlity.ComputeHash(t);return setTimeout(a.renderCard.bind(a,r,t),0),'<div id="'+r+'_wrapper"><div id="'+r+'" class="w-100 h-100 border bd-default bg-white" style="min-height: 520px; min-width: 500px;"></div></div>'}))}}(e.Modules||(e.Modules={}))}(FEF||(FEF={})),function(e){!function(e){class t extends e.ModuleBase{constructor(){super("lorecard.list")}createItem(e,t,a){const r=document.createElement("li");r.classList.add("step-list-item");const i=document.createElement("h4");i.innerText=t,r.appendChild(i);const o=document.createElement("p");return o.classList.add("w-100"),o.innerText=a,r.appendChild(o),e.appendChild(r),r}initCard(e,t,a){var r=document.getElementById(a+"_wrapper");r.classList.add("flex-justify-center","flex-align-center");const i=document.getElementById(a),o=document.createElement("ul");o.classList.add("step-list");var n=this;_.forEach(t.items,e=>{n.createItem(o,e.title,e.description)}),i.appendChild(o);var s=KC.Tools.LoreService.getUri_NoteLink(e);const d=this.createLinkButton_Note(s);var c=KC.Tools.LoreService.getUri_Author_FromNoteLink(s);const l=this.createLinkButton_Author(c),u=this.createDiv_Settings(d,l);r.innerHTML="",r.appendChild(i),r.appendChild(u)}renderCard(e,t){let a=this;LoreCard.api.getNoteByURL(t,r=>{a.initCard(t,r,e)})}}e.ListCard=t,e.ListCardPlugin=function(){const{Editor:e}=toastui;var a=new t;e.codeBlockManager.setReplacer(a.ModuleName,(function(e){var t=a.getDataUri(e);if(0===t.length||t.indexOf("http")<0)return"<p class='fg-red'>Invalid format for data uri</p>";var r="divLoreSection_"+KC.Tools.CommonUtitlity.ComputeHash(t);return setTimeout(a.renderCard.bind(a,r,t),0),'<div id="'+r+'_wrapper"><div id="'+r+'" class="w-100 h-100 border bd-default bg-white" style="min-height: 520px; min-width: 500px;"></div></div>'}))}}(e.Modules||(e.Modules={}))}(FEF||(FEF={})),function(e){!function(t){class a extends t.ModuleBase{constructor(){super("lorecard.mind"),this.CyCache={}}setupFullScreen(t,a){const r=document.getElementById(t),i=r.offsetWidth,o=r.offsetHeight;e.Tools.UIHelper.SetupFullScreen(r,this.tryRefreshCyAfterResize(t,i,o)),a.innerHTML="<span class='mif-enlarge fg-cyan'></span>",a.addEventListener("click",()=>{e.Tools.UIHelper.LaunchFullScreen(r)})}tryRefreshCyAfterResize(e,t,a){const r=document.getElementById(e);r.style.width=t+"px",r.style.height=a+"px";var i=this.CyCache[e];i&&(i.zoom(1),i.resize(),i.center())}initCytoscape(e,t,r){var i=document.getElementById(r+"_wrapper"),o=document.getElementById(r),n=KC.Tools.LoreService.getUri_NoteLink(e);const s=this.createLinkButton_Note(n);var d=KC.Tools.LoreService.getUri_Author_FromNoteLink(n);const c=this.createLinkButton_Author(d),l=this.createDiv_Settings(s,c);i.innerHTML="",i.appendChild(o),i.appendChild(l);var u=cytoscape({container:o,zoom:1,elements:_.concat(t.nodes,t.edges),style:a.cyStyles,layout:{name:"preset"}});return this.CyCache[r]=u,u}renderCytoscape(e,t){let a=this;LoreCard.api.getNoteByURL(t,r=>{a.initCytoscape(t,r,e)})}}a.cyStyles=[{selector:"node",style:{"text-wrap":"wrap","text-max-width":"200px","background-color":"#acf","border-width":1,"border-color":"#69c"}},{selector:"node[title]",style:{label:"data(title)"}},{selector:"edge",style:{"curve-style":"unbundled-bezier","control-point-distance":30,"control-point-weight":.5,opacity:.9,"overlay-padding":"3px","overlay-opacity":0,label:"data(title)","font-family":"FreeSet,Arial,sans-serif","font-size":9,"font-weight":"bold","text-background-opacity":1,"text-background-color":"#ffffff","text-background-padding":3,"text-background-shape":"roundrectangle",width:1,"target-arrow-shape":"vee"}}],t.MindCard=a,t.MindCardPlugin=function(){const{Editor:e}=toastui;var t=new a;e.codeBlockManager.setReplacer(t.ModuleName,(function(e){var a=t.getDataUri(e);if(0===a.length||a.indexOf("http")<0)return"<p class='fg-red'>Invalid format for data uri</p>";var r="divLoreSection_"+KC.Tools.CommonUtitlity.ComputeHash(a);return setTimeout(t.renderCytoscape.bind(t,r,a),0),'<div id="'+r+'_wrapper"><div id="'+r+'" class="w-100 h-100 border bd-default bg-white" style="min-height: 520px; min-width: 500px;"></div></div>'}))}}(e.Modules||(e.Modules={}))}(FEF||(FEF={})),function(e){!function(t){class a extends t.ModuleBase{constructor(){super("lorecard.section")}createCardHeader(e,t){const a=document.createElement("div");return a.classList.add("card-header"),a.innerText=t,a}createCardFooter(e){const t=document.createElement("button");t.classList.add("flat-button","mif-arrow-right","mif-2x","fg-black"),t.onclick=t=>{$("#"+e).toggleClass("active")};const a=document.createElement("div");return a.classList.add("card-footer"),a.appendChild(t),a}createCardContent(e,t){var a=document.createElement("div");a.id="viewer_"+t+"_"+e,a.style.height="360px",a.style.overflowY="auto";const r=document.createElement("div");return r.classList.add("card-content"),r.appendChild(a),r}createMetroCard(e,t,a){const r=this.createCardHeader(e,a),i=this.createCardContent(e,t),o=this.createCardFooter(e),n=document.createElement("div");return n.classList.add("card"),n.appendChild(r),n.appendChild(i),n.appendChild(o),n}createCardSide(e,t,a){const r=this.createMetroCard(e,t,a),i=document.createElement("div");return i.classList.add(t),i.appendChild(r),i}initCard(t,a,r){var i=document.getElementById(r+"_wrapper");i.classList.add("flex-justify-center","flex-align-center");var o=document.getElementById(r);o.classList.add("flip-card","effect-on-active"),o.style.width="360px",o.style.height="520px";var n=this.createCardSide(r,"front",a.title),s=this.createCardSide(r,"back",a.title);o.appendChild(n),o.appendChild(s);var d=KC.Tools.LoreService.getUri_NoteLink(t);const c=this.createLinkButton_Note(d);var l=KC.Tools.LoreService.getUri_Author_FromNoteLink(d);const u=this.createLinkButton_Author(l),p=this.createDiv_Settings(c,u);i.innerHTML="",i.appendChild(o),i.appendChild(p),setTimeout(()=>{e.Tools.UIHelper.createTuiViewerUsingFactory("viewer_front_"+r,"",a.front?a.front.content:""),e.Tools.UIHelper.createTuiViewerUsingFactory("viewer_back_"+r,"",a.back?a.back.content:"")},100)}renderCard(e,t){let a=this;LoreCard.api.getNoteByURL(t,r=>{a.initCard(t,r,e)})}}t.SectionCard=a,t.SectionCardPlugin=function(){const{Editor:e}=toastui;var t=new a;e.codeBlockManager.setReplacer(t.ModuleName,(function(e){var a=t.getDataUri(e);if(0===a.length||a.indexOf("http")<0)return"<p class='fg-red'>Invalid format for data uri</p>";var r="divLoreSection_"+KC.Tools.CommonUtitlity.ComputeHash(a);return setTimeout(t.renderCard.bind(t,r,a),0),'<div id="'+r+'_wrapper"><div id="'+r+'" class="w-100 h-100 border bd-default bg-white" style="min-height: 520px; min-width: 500px;"></div></div>'}))}}(e.Modules||(e.Modules={}))}(FEF||(FEF={})),function(e){!function(e){e.UIHelper=class{static ShowCharm(e){$("#"+e).data("charms").open()}static HideCharm(e){$("#"+e).data("charms").close()}static ShowOrHideCharm(e,t){var a=$("#"+e).data("charms");!0===a.element.data("opened")&&!0===t?a.close():a.open()}static disableElement(e){$("#"+e).attr("disabled","true")}static enableElement(e){$("#"+e).attr("disabled","false")}static ShowMessage(e,t){Metro.notify.create(t,e,{cls:"info"})}static ShowError(e,t){Metro.notify.create(t,e,{cls:"alert"})}static ToastError(e){(0,Metro.toast.create)(e,null,5e3,"bg-red fg-white")}static ToastMessage(e){(0,Metro.toast.create)(e,null,5e3,"bg-green fg-white")}static LaunchFullScreen(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}static SetupFullScreen(e,t){e.addEventListener&&(e.addEventListener("webkitfullscreenchange",()=>{t&&t()},!1),e.addEventListener("mozfullscreenchange",()=>{t&&t()},!1),e.addEventListener("fullscreenchange",()=>{t&&t()},!1),e.addEventListener("MSFullscreenChange",()=>{t&&t()},!1))}static getIcon(e){var t="mif-embed2";switch(e){case KC.Models.ModelData.Type_Document:t="mif-file-code";break;case KC.Models.ModelData.Type_Mind:t="mif-share";break;case KC.Models.ModelData.Type_Section:t="mif-book-reference";break;case KC.Models.ModelData.Type_Dialog:t="mif-chat-bubble-outline";break;case KC.Models.ModelData.Type_XY:t="mif-windows";break;case KC.Models.ModelData.Type_5W2H1E:t="mif-dashboard";break;case KC.Models.ModelData.Type_Topic:t="mif-folder-special2";break;case KC.Models.ModelData.Type_LanguagePack:case KC.Models.ModelData.ItemType_vocabulary:t="mif-language";break;default:t="mif-embed2"}return t}static createTuiViewerUsingFactory(e,t,a){const r=toastui.Editor,{chart:i,codeSyntaxHighlight:o,colorSyntax:n,tableMergedCell:s,uml:d}=r.plugin;return r.factory({el:document.querySelector("#"+e),height:void 0===t||t.length<=4?"400px":t,initialValue:a,viewer:!0,usageStatistics:!1,plugins:[[i,{minWidth:100,maxWidth:600,minHeight:100,maxHeight:300}],o,s,d]})}}}(e.Tools||(e.Tools={}))}(FEF||(FEF={})),function(e){!function(e){class t{}t.Type_Document="document",t.Type_Article="article",t.Type_Couplet="couplet",t.Type_Dialog="dialog",t.Type_Section="section",t.Type_List="list",t.Type_Tree="tree",t.Type_Mind="mind",t.Type_XY="xy",t.Type_5W2H1E="5w2h1e",t.Type_Topic="topic",t.Type_LanguagePack="language-pack",t.Type_MathPack="math-pack",t.Type_HistoryPack="history-pack",t.ItemType_vocabulary="language:vocabulary",e.ModelData=t}(e.Models||(e.Models={}))}(KC||(KC={})),function(e){!function(e){e.CommonUtitlity=class{static ComputeHash(e){var t=0;if(0===e.length)return t;for(var a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t&=t}return t}}}(e.Tools||(e.Tools={}))}(KC||(KC={})),function(e){!function(e){e.StringUtility=class{static EscapeSpecialChars(e){return e.replace(/\\n/g,"\\n").replace(/\\'/g,"\\'").replace(/\\"/g,'\\"').replace(/\\&/g,"\\&").replace(/\\r/g,"\\r").replace(/\\t/g,"\\t").replace(/\\b/g,"\\b").replace(/\\f/g,"\\f")}}}(e.Tools||(e.Tools={}))}(KC||(KC={}));