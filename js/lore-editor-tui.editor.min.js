"use strict";class LoreService{constructor(e,t){this.appId=e,this.appSecret=t}getNoteByURL(e,t){var a=LoreService.getUri_Api_GetNote(e);$.ajax({url:a,dataType:"json",type:"GET",contentType:"application/x-www-form-urlencoded",data:"appid="+this.appId,async:!0,processData:!1,cache:!1,crossDomain:!0,success:function(e,a,r){"function"!=typeof t||t(e)},error:function(e,t,a){var r="��Status��"+t+"��error��"+a+"��others��"+e.responseText;UIHelper.ShowError("ERROR",r)}})}getNote(e,t,a,r){var i="/api/"+LoreService.apiVersion+"/"+e+"/"+t+"/"+a;this.getNoteByURL(i,r)}static getUri_Api_GetNote(e){var t=e;if(e.startsWith("https://localhost")&&!e.startsWith("https://localhost:44356/api")){LoreService.apiUriPrefix="https://localhost:44356/api/"+LoreService.apiVersion+"/";t=LoreService.apiUriPrefix+e.substring("https://localhost:44356/".length)}else e.startsWith("https://lore.chuci.info")&&!e.startsWith("https://lore.chuci.info/api")&&(LoreService.apiUriPrefix="https://lore.chuci.info/api/"+LoreService.apiVersion+"/",t=LoreService.apiUriPrefix+e.substring(LoreService.uriPrefix.length));return t}static getUri_NoteLink(e){var t=e,a="/api/"+LoreService.apiVersion;return e.indexOf(a)>=0&&(t=e.replace(a,"")),t}static getUri_Author_FromNoteLink(e){var t=LoreService.uriPrefix;e.startsWith("https://localhost")&&(t="https://localhost:44356/");var a=e.substring(t.length),r=a.indexOf("/");return t+a.substring(0,r)}static getUserName_FromAuthorLink(e){var t=e.lastIndexOf("/");return e.substring(t+1)}static fitDialog(e){var t=e.agents;return _.forEach(e.items,e=>{var a=e.agentId,r=_.find(t,(function(e){return e.id===a}));e.name=r.name,e.avatar="https://robohash.org/"+a+".png",e.time=new Date(e.time)}),e.items}}LoreService.uriPrefix="https://lore.chuci.info/",LoreService.apiVersion="v1",LoreService.apiUriPrefix="https://lore.chuci.info/api/"+LoreService.apiVersion+"/";class LoreCard{static inititialize(){return void 0===LoreCard.api&&LoreCard.initService("",""),LoreCard.api}static initService(e,t){return LoreCard.api=new LoreService(e,t),LoreCard.api}}class LoreEditor{constructor(e){this.editor=e,this.toolbar=this.editor.getUI().getToolbar(),this.init()}addToolbarCommand_Dialog(){this.editor.eventManager.addEventType("Event_LoreCard_Dialog");var e=this;this.editor.eventManager.listen("Event_LoreCard_Dialog",(function(){if(!1!==e.editor.isMarkdownMode()){var t=["","```lorecard."+ModelData.Type_Dialog,"data: ","```",""].join("\n");e.editor.insertText(t)}})),this.toolbar.addButton({name:"cmdDialog",className:"fa fa-accessible-icon",event:"Event_LoreCard_Dialog",tooltip:"lore:> dialog",$el:$('<div class="custom-button"><i class="icon mif-chat-bubble-outline fg-orange"></i></div>')},1)}addToolbarCommand_Mind(){this.editor.eventManager.addEventType("Event_LoreCard_Mind");var e=this;this.editor.eventManager.listen("Event_LoreCard_Mind",(function(){if(!1!==e.editor.isMarkdownMode()){var t=["","```lorecard."+ModelData.Type_Mind,"data: ","```",""].join("\n");e.editor.insertText(t)}})),this.toolbar.addButton({name:"cmdMind",className:"fa fa-accessible-icon",event:"Event_LoreCard_Mind",tooltip:"lore:> mind",$el:$('<div class="custom-button"><i class="icon mif-share fg-orange"></i></div>')},1)}addToolbarCommand_Section(){this.editor.eventManager.addEventType("Event_LoreCard_Section");var e=this;this.editor.eventManager.listen("Event_LoreCard_Section",(function(){if(!1!==e.editor.isMarkdownMode()){var t=["","```lorecard."+ModelData.Type_Section,"data: ","```",""].join("\n");e.editor.insertText(t)}})),this.toolbar.addButton({name:"cmdSection",className:"fa fa-accessible-icon",event:"Event_LoreCard_Section",tooltip:"lore:> section",$el:$('<div class="custom-button"><i class="icon mif-book-reference fg-orange"></i></div>')},1)}addToolbarCommand_List(){this.editor.eventManager.addEventType("Event_LoreCard_List");var e=this;this.editor.eventManager.listen("Event_LoreCard_List",(function(){if(!1!==e.editor.isMarkdownMode()){var t=["","```lorecard."+ModelData.Type_List,"data: ","```",""].join("\n");e.editor.insertText(t)}})),this.toolbar.addButton({name:"cmdSection",className:"fa fa-accessible-icon",event:"Event_LoreCard_List",tooltip:"lore:> list",$el:$('<div class="custom-button"><i class="icon mif-list-numbered fg-orange"></i></div>')},1)}init(){this.addToolbarCommand_Dialog(),this.addToolbarCommand_Mind(),this.addToolbarCommand_Section(),this.addToolbarCommand_List()}}class ModuleBase{constructor(e){this.api=LoreCard.inititialize(),this.ModuleName=e}getDataUri(e){var t=e.match(/^.*((\r\n|\n|\r)|$)/gm),a="";return t&&t.length>0&&(t.forEach(e=>{e.startsWith("dataUri:")?a=_.replace(e,"dataUri:",""):e.startsWith("data:")?a=_.replace(e,"data:",""):e.startsWith("uri:")&&(a=_.replace(e,"uri:",""))}),a=_.trim(a)),a}createLinkButton_Note(e){const t=document.createElement("a");return t.classList.add("button","light","ml-3"),t.style.lineHeight="100%",t.style.textDecoration="none",t.innerText="Lore",t.href=e,t.target="_blank",t}createLinkButton_Author(e){const t=document.createElement("a");return t.classList.add("button","light","ml-3"),t.style.lineHeight="100%",t.style.textDecoration="none",t.innerHTML='<span class="mif-user"></span> '+LoreService.getUserName_FromAuthorLink(e),t.href=e,t.target="_blank",t}createDiv_Settings(e,t){const a=document.createElement("div");return a.classList.add("mt-3","d-flex","flex-justify-center","flex-align-center"),t&&a.appendChild(t),e&&a.appendChild(e),a}}class DialogCard extends ModuleBase{constructor(){super("lorecard.dialog")}runChatFlow(e,t){var a=$("#"+e).data("chat");a.clear();let r=0;for(var i=t.items,o=0;o<i.length;o++)!function(e){r+=1e3*i[e].delay,setTimeout((function(){var t=i[e];a.add(t)}),r)}(o)}initCard(e,t,a){var r=document.getElementById(a+"_wrapper");r.classList.add("flex-justify-center","flex-align-center");var i=document.getElementById(a);i.id=a,i.setAttribute("data-role","chat"),i.setAttribute("data-readonly","true"),i.style.maxHeight="500px";var o=LoreService.getUri_NoteLink(e);const n=this.createLinkButton_Note(o);var d=LoreService.getUri_Author_FromNoteLink(o);const s=this.createLinkButton_Author(d),l=document.createElement("button");l.classList.add("button","light"),l.style.lineHeight="100%",l.innerHTML='<span class="mif-refresh"></span>',l.onclick=e=>{module_LoreCard_Dialog.runChatFlow(a,t)};const c=this.createDiv_Settings(n,s);c.appendChild(l),r.innerHTML="",r.appendChild(i),r.appendChild(c)}renderCard(e,t){LoreCard.api.getNoteByURL(t,a=>{LoreService.fitDialog(a),module_LoreCard_Dialog.initCard(t,a,e)})}}var module_LoreCard_Dialog=new DialogCard;tui.Editor.defineExtension(module_LoreCard_Dialog.ModuleName,(function(){tui.Editor.codeBlockManager.setReplacer(module_LoreCard_Dialog.ModuleName,(function(e){var t=module_LoreCard_Dialog.getDataUri(e);if(0===t.length||t.indexOf("http")<0)return"<p class='fg-red'>Invalid format for data uri</p>";var a="divLoreDialog_"+CommonUtitlity.ComputeHash(t);return setTimeout(module_LoreCard_Dialog.renderCard.bind(null,a,t),0),'<div id="'+a+'_wrapper"><div id="'+a+'" class="w-100 h-100 border bd-default bg-white" style="min-height: 520px; min-width: 500px;"></div></div>'}))}));class MindCard extends ModuleBase{constructor(){super("lorecard.mind"),this.CyCache={}}setupFullScreen(e,t){const a=document.getElementById(e),r=a.offsetWidth,i=a.offsetHeight;UIHelper.SetupFullScreen(a,this.tryRefreshCyAfterResize(e,r,i)),t.innerHTML="<span class='mif-enlarge fg-cyan'></span>",t.addEventListener("click",()=>{UIHelper.LaunchFullScreen(a)})}tryRefreshCyAfterResize(e,t,a){const r=document.getElementById(e);r.style.width=t+"px",r.style.height=a+"px";var i=this.CyCache[e];i&&(i.zoom(1),i.resize(),i.center())}initCytoscape(e,t,a){var r=document.getElementById(a+"_wrapper"),i=document.getElementById(a),o=LoreService.getUri_NoteLink(e);const n=this.createLinkButton_Note(o);var d=LoreService.getUri_Author_FromNoteLink(o);const s=this.createLinkButton_Author(d),l=this.createDiv_Settings(n,s);r.innerHTML="",r.appendChild(i),r.appendChild(l);var c=cytoscape({container:i,zoom:1,elements:_.concat(t.nodes,t.edges),style:MindCard.cyStyles,layout:{name:"preset"}});return this.CyCache[a]=c,c}renderCytoscape(e,t){LoreCard.api.getNoteByURL(t,a=>{module_LoreCard_Mind.initCytoscape(t,a,e)})}}MindCard.cyStyles=[{selector:"node",style:{"text-wrap":"wrap","text-max-width":"200px","background-color":"#acf","border-width":1,"border-color":"#69c"}},{selector:"node[title]",style:{label:"data(title)"}},{selector:"edge",style:{"curve-style":"unbundled-bezier","control-point-distance":30,"control-point-weight":.5,opacity:.9,"overlay-padding":"3px","overlay-opacity":0,label:"data(title)","font-family":"FreeSet,Arial,sans-serif","font-size":9,"font-weight":"bold","text-background-opacity":1,"text-background-color":"#ffffff","text-background-padding":3,"text-background-shape":"roundrectangle",width:1,"target-arrow-shape":"vee"}}];var module_LoreCard_Mind=new MindCard;tui.Editor.defineExtension(module_LoreCard_Mind.ModuleName,(function(){tui.Editor.codeBlockManager.setReplacer(module_LoreCard_Mind.ModuleName,(function(e){var t=module_LoreCard_Mind.getDataUri(e);if(0===t.length||t.indexOf("http")<0)return"<p class='fg-red'>Invalid format for data uri</p>";var a="divLoreMind_"+CommonUtitlity.ComputeHash(t);return setTimeout(module_LoreCard_Mind.renderCytoscape.bind(null,a,t),0),'<div id="'+a+'_wrapper"><div id="'+a+'" class="w-100 h-100 border bd-default bg-white" style="min-height: 500px; min-width: 500px;"></div></div>'}))}));class SectionCard extends ModuleBase{constructor(){super("lorecard.section")}createCardHeader(e,t){const a=document.createElement("div");return a.classList.add("card-header"),a.innerText=t,a}createCardFooter(e){const t=document.createElement("button");t.classList.add("flat-button","mif-arrow-right","mif-2x","fg-black"),t.onclick=t=>{$("#"+e).toggleClass("active")};const a=document.createElement("div");return a.classList.add("card-footer"),a.appendChild(t),a}createCardContent(e,t){var a=document.createElement("div");a.id="viewer_"+t+"_"+e,a.style.height="360px",a.style.overflowY="auto";const r=document.createElement("div");return r.classList.add("card-content"),r.appendChild(a),r}createMetroCard(e,t,a){const r=this.createCardHeader(e,a),i=this.createCardContent(e,t),o=this.createCardFooter(e),n=document.createElement("div");return n.classList.add("card"),n.appendChild(r),n.appendChild(i),n.appendChild(o),n}createCardSide(e,t,a){const r=this.createMetroCard(e,t,a),i=document.createElement("div");return i.classList.add(t),i.appendChild(r),i}initCard(e,t,a){var r=document.getElementById(a+"_wrapper");r.classList.add("flex-justify-center","flex-align-center");var i=document.getElementById(a);i.classList.add("flip-card","effect-on-active"),i.style.width="360px",i.style.height="520px";var o=this.createCardSide(a,"front",t.title),n=this.createCardSide(a,"back",t.title);i.appendChild(o),i.appendChild(n);var d=LoreService.getUri_NoteLink(e);const s=this.createLinkButton_Note(d);var l=LoreService.getUri_Author_FromNoteLink(d);const c=this.createLinkButton_Author(l),u=this.createDiv_Settings(s,c);r.innerHTML="",r.appendChild(i),r.appendChild(u),setTimeout(()=>{tui.Editor.factory({el:document.querySelector("#viewer_front_"+a),initialEditType:"markdown",previewStyle:"vertical",height:"400px",initialValue:t.front.content,viewer:!0,exts:["table","uml"]}),tui.Editor.factory({el:document.querySelector("#viewer_back_"+a),initialEditType:"markdown",previewStyle:"vertical",height:"400px",initialValue:t.back.content,viewer:!0,exts:["table","uml"]})},100)}renderCard(e,t){LoreCard.api.getNoteByURL(t,a=>{module_LoreCard_Section.initCard(t,a,e)})}}var module_LoreCard_Section=new SectionCard;tui.Editor.defineExtension(module_LoreCard_Section.ModuleName,(function(){tui.Editor.codeBlockManager.setReplacer(module_LoreCard_Section.ModuleName,(function(e){var t=module_LoreCard_Section.getDataUri(e);if(0===t.length||t.indexOf("http")<0)return"<p class='fg-red'>Invalid format for data uri</p>";var a="divLoreSection_"+CommonUtitlity.ComputeHash(t);return setTimeout(module_LoreCard_Section.renderCard.bind(null,a,t),0),'<div id="'+a+'_wrapper"><div id="'+a+'" class="w-100 h-100 border bd-default bg-white" style="min-height: 520px; min-width: 500px;"></div></div>'}))}));class UIHelper{static ShowCharm(e){$("#"+e).data("charms").open()}static HideCharm(e){$("#"+e).data("charms").close()}static ShowOrHideCharm(e,t){var a=$("#"+e).data("charms");!0===a.element.data("opened")&&!0===t?a.close():a.open()}static disableElement(e){$("#"+e).attr("disabled","true")}static enableElement(e){$("#"+e).attr("disabled","false")}static ShowMessage(e,t){Metro.notify.create(t,e,{cls:"info"})}static ShowError(e,t){Metro.notify.create(t,e,{cls:"alert"})}static ToastError(e){(0,Metro.toast.create)(e,null,5e3,"bg-red fg-white")}static ToastMessage(e){(0,Metro.toast.create)(e,null,5e3,"bg-green fg-white")}static LaunchFullScreen(e){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}static SetupFullScreen(e,t){e.addEventListener&&(e.addEventListener("webkitfullscreenchange",()=>{t&&t()},!1),e.addEventListener("mozfullscreenchange",()=>{t&&t()},!1),e.addEventListener("fullscreenchange",()=>{t&&t()},!1),e.addEventListener("MSFullscreenChange",()=>{t&&t()},!1))}static getIcon(e){var t="mif-embed2";switch(e){case ModelData.Type_Document:t="mif-file-code";break;case ModelData.Type_Mind:t="mif-share";break;case ModelData.Type_Section:t="mif-book-reference";break;case ModelData.Type_Dialog:t="mif-chat-bubble-outline";break;case ModelData.Type_XY:t="mif-windows";break;case ModelData.Type_5W2H1E:t="mif-dashboard";break;case ModelData.Type_Topic:t="mif-folder-special2";break;case ModelData.Type_LanguagePack:case ModelData.ItemType_vocabulary:t="mif-language";break;default:t="mif-embed2"}return t}}class ModelData{}ModelData.Type_Document="document",ModelData.Type_Article="article",ModelData.Type_Couplet="couplet",ModelData.Type_Dialog="dialog",ModelData.Type_Section="section",ModelData.Type_List="list",ModelData.Type_Tree="tree",ModelData.Type_Mind="mind",ModelData.Type_XY="xy",ModelData.Type_5W2H1E="5w2h1e",ModelData.Type_Topic="topic",ModelData.Type_LanguagePack="language-pack",ModelData.Type_MathPack="math-pack",ModelData.Type_HistoryPack="history-pack",ModelData.ItemType_vocabulary="language:vocabulary";class CommonUtitlity{static ComputeHash(e){var t=0;if(0===e.length)return t;for(var a=0;a<e.length;a++){t=(t<<5)-t+e.charCodeAt(a),t&=t}return t}}class ListCard extends ModuleBase{constructor(){super("lorecard.list")}createItem(e,t,a){const r=document.createElement("li");r.classList.add("step-list-item");const i=document.createElement("h4");i.innerText=t,r.appendChild(i);const o=document.createElement("p");return o.classList.add("w-100"),o.innerText=a,r.appendChild(o),e.appendChild(r),r}initCard(e,t,a){var r=document.getElementById(a+"_wrapper");r.classList.add("flex-justify-center","flex-align-center");const i=document.getElementById(a),o=document.createElement("ul");o.classList.add("step-list");var n=this;_.forEach(t.items,e=>{n.createItem(o,e.title,e.description)}),i.appendChild(o);var d=LoreService.getUri_NoteLink(e);const s=this.createLinkButton_Note(d);var l=LoreService.getUri_Author_FromNoteLink(d);const c=this.createLinkButton_Author(l),u=this.createDiv_Settings(s,c);r.innerHTML="",r.appendChild(i),r.appendChild(u)}renderCard(e,t){LoreCard.api.getNoteByURL(t,a=>{module_LoreCard_List.initCard(t,a,e)})}}var module_LoreCard_List=new ListCard;tui.Editor.defineExtension(module_LoreCard_List.ModuleName,(function(){tui.Editor.codeBlockManager.setReplacer(module_LoreCard_List.ModuleName,(function(e){var t=module_LoreCard_List.getDataUri(e);if(0===t.length||t.indexOf("http")<0)return"<p class='fg-red'>Invalid format for data uri</p>";var a="divLoreList_"+CommonUtitlity.ComputeHash(t);return setTimeout(module_LoreCard_List.renderCard.bind(null,a,t),0),'<div id="'+a+'_wrapper" class="clearfix"><div id="'+a+'" class="w-100 h-100 border bd-default bg-white" style="min-height: 200px; min-width: 500px;"></div></div>'}))}));